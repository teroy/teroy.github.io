<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.proxy.ustclug.org/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />









  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Teroy’s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Teroy’s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Teroy’s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: false,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> Teroy’s Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=59559514";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Teroy’s Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/03/php-ZipArchive-extension-issue/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/03/php-ZipArchive-extension-issue/" itemprop="url">
                  ZipArchive扩展遇到的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-03T00:00:00+08:00">
                2017-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>近期已经遇到了两个关于php扩展zip压缩的问题，而且问题都属于比较难以排查的，因为都跟环境有关系，所以这里总结记录一下。</p>
<h4 id="问题1：php版本问题"><a href="#问题1：php版本问题" class="headerlink" title="问题1：php版本问题"></a>问题1：php版本问题</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$zip = <span class="keyword">new</span> \ZipArchive;</span><br><span class="line">$res = $zip-&gt;open($destination, \ZIPARCHIVE::OVERWRITE);</span><br><span class="line"><span class="keyword">if</span> ($res == <span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在php5.5下，以上代码是可以正常运行，当$destination这个文件路径不存在的时候会创建，如果存在则重新生成并覆盖。我们线上的部署环境是用php5.5，我本机使用php5.6，然而这段代码在php5.6下运行就会报错，当$destination不存在时候它无法生成新文件！<br>stackoverflow一番之后，顺利找到问题的<a href="https://bugs.php.net/bug.php?id=71064" target="_blank" rel="noopener">根源</a>，php5.6已经不再支持这个特性，为了解决这个问题必须使用下面的代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$zip = <span class="keyword">new</span> \ZipArchive;</span><br><span class="line"><span class="comment">// 同时指定\ZIPARCHIVE::CREATE 解决php5.6的不兼容问题</span></span><br><span class="line">$res = $zip-&gt;open($destination, \ZIPARCHIVE::CREATE | \ZIPARCHIVE::OVERWRITE);</span><br><span class="line"><span class="keyword">if</span> ($res == <span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="问题2：zip扩展版本问题"><a href="#问题2：zip扩展版本问题" class="headerlink" title="问题2：zip扩展版本问题"></a>问题2：zip扩展版本问题</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$zip = <span class="keyword">new</span> \ZipArchive;</span><br><span class="line">$res = $zip-&gt;open($destination, \ZIPARCHIVE::CREATE | \ZIPARCHIVE::OVERWRITE);</span><br><span class="line"><span class="keyword">if</span> ($res === <span class="keyword">true</span>) &#123;</span><br><span class="line">    $fileName = iconv(<span class="string">"UTF-8"</span>, <span class="string">"GBK//IGNORE"</span>, $fileName);</span><br><span class="line">    $zip-&gt;addFile($exportFilePath, $fileName);</span><br><span class="line">    $zip-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到fileName变量做了一次编码转换，因为当文件名称为中文的时候，压缩包解压出来的文件名会变为乱码，所以这里做了一次特殊转码。<br>然而，同样的代码到了另外一台服务器上运行，会发现压缩包下载下来双击打开里面的文件会被隐藏了！一步一步调试代码后，发现只要移除那一句对fileName变量的编码转换，压缩就会变得正常了，中文也不会出现乱码，但是有些环境不转码又会出现乱码，这让人非常怀疑是扩展版本问题。执行php –ri zip命令查看扩展的版本，确实也发现了两个环境的扩展版本不一样，乱码的环境zip版本是1.11.0，而另一个环境是1.13.0，这样就基本定位到问题了，1.11.0版本的zip扩展对中文的文件名称支持地不好，在1.13.0版本就修复了这个问题，然而如果代码中对文件名称做了特殊转码，在1.13.0版本又会引发新的问题，压缩包打开不显示文件。<br>最终的解决方案是升级所有环境的zip扩展到1.13.0版本，然后移除掉对file转码的代码。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/06/linux-dir/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/06/linux-dir/" itemprop="url">
                  linux目录文件介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-06T00:00:00+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <table><tr><td width="70px">目录</td><td>说明</td></tr><tr><td>/home</td><td>用户主文件夹，当创建一个普通用户的时候，一般都会生成一个同名的文件夹在home目录下。</td></tr><tr></tr><tr><td>/root</td><td>root用户的主文件夹。</td></tr><tr></tr><tr><td>/etc</td><td>配置文件目录。注意：/etc/init.d为service服务的脚本存放路径。</td></tr><tr></tr><tr><td>/bin</td><td>系统的可执行文件存放目录，该文件下的命令可被所有用户使用，这个目录一般我们是不需要去动它。</td></tr><tr></tr><tr><td>/sbin</td><td>这个目录下的命令root用户可以用来设置系统环境，一般我们也不需要去动它。</td></tr><tr></tr><tr><td>/usr</td><td>usr并非user的简写，而是Unix Software Resource，所有系统默认的软件都会放置到/usr下，有些类似于windows系统的C:\Windows\和C:\Program files\的结合体。</td></tr><tr></tr><tr><td>/opt</td><td>第三方软件包安装目录。我们用yum安装的包可能会安装到该目录下，注意与/usr/local目录区分，/usr/local通常是用来作为下载源码编译安装的目录。</td></tr><tr></tr><tr><td>/proc</td><td>这个目录属于虚拟文件系统，它的所有数据都是放在内存中，本身不占用任何硬盘资源，用来存储进程相关的信息。eg：/proc/进程id/status 查看某个进程的相关信息</td></tr><tr></tr><tr><td>/tmp</td><td>临时文件夹，所有的用户都有rwx权限，linux会定期自动清理tmp下面的文件，所以这个目录一般用来存放一些不重要的临时文件。</td></tr><tr></tr><tr><td>/var</td><td>主要存储变动频繁数据的目录。eg：/var/cache 应用程序的缓存目录；/var/log 日记目录；/var/run 应用程序的pid存放目录</td></tr><tr></tr></table>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/12/composer/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/12/composer/" itemprop="url">
                  composer使用实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-12T00:00:00+08:00">
                2017-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>composer作为php领域最为流行的包依赖管理器，基本也成为每个phper的必备技能之一，composer官方也提供了很好的<a href="http://docs.phpcomposer.com/00-intro.html" target="_blank" rel="noopener">中文学习资料</a>，整体而言也是很容易上手的。自己在使用composer的过程中也遇到了概念不清晰和实践方面的问题，所以用这篇文章来记录总结一下。</p>
<h4 id="问题1：该不该将vendor文件夹包裹在源代码管理器-git、svn等-中？"><a href="#问题1：该不该将vendor文件夹包裹在源代码管理器-git、svn等-中？" class="headerlink" title="问题1：该不该将vendor文件夹包裹在源代码管理器(git、svn等)中？"></a>问题1：该不该将vendor文件夹包裹在源代码管理器(git、svn等)中？</h4><p>vendor文件夹通常都会比较大，不将其放在源代码管理器中，可以减少仓库的体积和历史提交差异记录，加快代码签入签出的速度，所以一般不将vendor包放在仓库中。但是需要注意一些问题，因为有时候composer安装的过程中需要执行一些检验token的操作，在持续集成的工具中要预留一些解决方案。</p>
<h4 id="问题2：composer提供了install和update命令来维护vendor包，那么这两个命令有什么区别呢？"><a href="#问题2：composer提供了install和update命令来维护vendor包，那么这两个命令有什么区别呢？" class="headerlink" title="问题2：composer提供了install和update命令来维护vendor包，那么这两个命令有什么区别呢？"></a>问题2：composer提供了install和update命令来维护vendor包，那么这两个命令有什么区别呢？</h4><p>与composer明确相关的有三个东西：composer.json文件、composer.lock文件和vendor文件夹。后两者都由composer自行管理，所以与开发者密切相关的就是composer.json文件。<br>要回答这个问题，前提就是要区分应用场景。假如一个项目之前完全没用过composer，现在刚刚创建好了composer.json文件，那么用install和update命令都可以完成同样的工作：生成包源文件集合vendor和composer.lock锁文件。两个命名之间没有本质区别。<br>假如项目已经使用了composer，现在修改了composer.json文件，想修改包的版本或者增加第三方包的引入，那么必须使用update命令，因为install命令会根据composer.lock来生成包源文件，它是不会去识别composer.json的改动的。<br>上述的场景中，用update命令就可以满足了，那么install命令应该在什么场景下使用呢？答案就是在生产环境中。我们可以在开发环境中维护好composer.lock文件，并将.lock文件提交到代码仓库中，到了生产环境就只用install命令，根据.lock文件生成vendor包，就不会造成生产环境贸然更新了某个包与开发环境不一致的问题。</p>
<h4 id="问题3：composer的包版本号提供了多种约定方式，那么在项目中最好用哪种方式呢？"><a href="#问题3：composer的包版本号提供了多种约定方式，那么在项目中最好用哪种方式呢？" class="headerlink" title="问题3：composer的包版本号提供了多种约定方式，那么在项目中最好用哪种方式呢？"></a>问题3：composer的包版本号提供了多种约定方式，那么在项目中最好用哪种方式呢？</h4><p>composer官网明确介绍了包的约定方式：</p>
<ul>
<li>确切的版本号: 1.0.2</li>
<li>范围: &gt;=1.0 大于1.0的版本</li>
<li>通配符: 1.0.* 1.0下的子版本</li>
<li>赋值运算符: ~1.2 相当于范围&gt;=1.2,&lt;2.0 </li>
</ul>
<p>我们最常用的使用场景应该是在require下面包裹一个第三方组件进来，这时候我认为最好的方式是使用明确版本号的方式。但是为什么呢？理由很简单：保持第三方包的稳定。第三方包基本都会作版本更新，使用其他的约定方式则会存在一个问题：当前匹配的版本会变更。举个例子，假如我们用通配符的方式引入了monolog包（require {“monolog/monolog”:”*”}），现在项目中用的是1.0版本，隔了一阵子，monolog发布了2.0版本，而且与1.0版本的api有了明显的不兼容，我们在项目中执行了composer update命令，则会自动将版本更新为2.0版本，组件api改变了，原来的地方有可能就会出现报错。<br>至于如何知道第三方包的版本，我们可以直接在<a href="https://packagist.org" target="_blank" rel="noopener">packagist</a>搜索得到，可以自行选择引入的版本。</p>
<h4 id="问题4：composer执行安装命令后一直停留在等待界面？"><a href="#问题4：composer执行安装命令后一直停留在等待界面？" class="headerlink" title="问题4：composer执行安装命令后一直停留在等待界面？"></a>问题4：composer执行安装命令后一直停留在等待界面？</h4><p>这里有些小技巧可以改进这个问题。首先就是命令的后面加上-vvv，就可以打印出具体的debug信息，实时地知道现在的运行情况；很多时候等待过久是因为遇到不翻墙下不了包的问题，这时可以通过设置包的源为中国镜像，具体可以参考<a href="https://pkg.phpcomposer.com/" target="_blank" rel="noopener">这里</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/26/yii-foreach-issue/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/26/yii-foreach-issue/" itemprop="url">
                  yii框架遇到的数组引用循环问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-26T00:00:00+08:00">
                2017-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前所在的公司用的yii版本是2.0.3，最近上线了一个新功能后，有个地方突然出现了问题，出错的地方的代码简化如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$userIds = [<span class="string">'1'</span>, <span class="string">'2'</span>];</span><br><span class="line"><span class="keyword">foreach</span> ($userIds <span class="keyword">as</span> &amp;$userId) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">$count = \common\entities\User::find()-&gt;where([<span class="string">'user_id'</span> =&gt; $userIds])-&gt;count();</span><br><span class="line"><span class="comment">// var_dump($userIds);</span></span><br></pre></td></tr></table></figure></p>
<p>这里是用了yii的orm查询了数据，但是最后发现$userIds数组的最后一个元素被串改了，导致接下来的逻辑就出现了错误。在我把foreach循环中的引用&amp;去掉后，$userIds就没有被修改覆盖了，所以基本可以断定yii框架中应该是有地方改动了$userIds，同时也跟foreach循环使用&amp;有关。调试进去yii的框架代码中，追踪到这个方法会引起变量的改动：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildInCondition</span><span class="params">($operator, $operands, &amp;$params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($operands[<span class="number">0</span>], $operands[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Operator '$operator' requires two operands."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">list</span>($column, $values) = $operands;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($values === [] || $column === []) &#123;</span><br><span class="line">        <span class="keyword">return</span> $operator === <span class="string">'IN'</span> ? <span class="string">'0=1'</span> : <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> Query) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildSubqueryInCondition($operator, $column, $values, $params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $values = (<span class="keyword">array</span>) $values;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count($column) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildCompositeInCondition($operator, $column, $values, $params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($column)) &#123;</span><br><span class="line">        $column = reset($column);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $i =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">            $value = <span class="keyword">isset</span>($value[$column]) ? $value[$column] : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($value === <span class="keyword">null</span>) &#123;</span><br><span class="line">            $values[$i] = <span class="string">'NULL'</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($value <span class="keyword">instanceof</span> Expression) &#123;</span><br><span class="line">            $values[$i] = $value-&gt;expression;</span><br><span class="line">            <span class="keyword">foreach</span> ($value-&gt;params <span class="keyword">as</span> $n =&gt; $v) &#123;</span><br><span class="line">                $params[$n] = $v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $phName = <span class="keyword">self</span>::PARAM_PREFIX . count($params);</span><br><span class="line">            $params[$phName] = $value;</span><br><span class="line">            $values[$i] = $phName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strpos($column, <span class="string">'('</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">        $column = <span class="keyword">$this</span>-&gt;db-&gt;quoteColumnName($column);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count($values) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"$column $operator ("</span> . implode(<span class="string">', '</span>, $values) . <span class="string">')'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $operator = $operator === <span class="string">'IN'</span> ? <span class="string">'='</span> : <span class="string">'&lt;&gt;'</span>;</span><br><span class="line">        <span class="keyword">return</span> $column . $operator . reset($values);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了进一步验证问题，写了一段简化代码去模拟，最终顺利找到了问题所在：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        $data[$k] = $k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = [<span class="string">'1'</span>, <span class="string">'2'</span>];</span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> &amp;$item) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">test($data);</span><br><span class="line">var_dump($data); <span class="comment">// 输出：['1', 1]</span></span><br></pre></td></tr></table></figure></p>
<p>查阅了<a href="http://php.net/manual/zh/control-structures.foreach.php" target="_blank" rel="noopener">官方文档</a>中对foreach的使用描述，里面有谈到一个使用警告：数组最后一个元素的 $value 引用在 foreach 循环之后仍会保留，建议使用 unset() 来将其销毁。所以在使用foreach引用&amp;变量的时候，最好能在循环后unset变量，避免不必要的问题。<br>yii框架开发组应该也意识到了这个问题，经过测试，在2.0.10版中这个问题已经被修复了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/07/php-env/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/07/php-env/" itemprop="url">
                  php项目根据环境读取配置的方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-07T00:00:00+08:00">
                2017-01-07
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通常我们会将不同环境的配置使用不同名称的文件区分开来，比如开发环境使用dev.config，线上环境使用prod.conf，来尽可能地减少混淆出错的可能性，但是我们的代码是同一套，这样就会带来一个问题：如何根据当前的部署环境读取合适的配置？针对这个问题，根据一些实战经验，这里谈一下自己总结的三种方案。</p>
<h4 id="方案一：将环境配置文件从版本控制系统中忽略"><a href="#方案一：将环境配置文件从版本控制系统中忽略" class="headerlink" title="方案一：将环境配置文件从版本控制系统中忽略"></a>方案一：将环境配置文件从版本控制系统中忽略</h4><p>我们可以在项目中定义一个文件env.php，并在env.php定义具体的环境变量，同时将这个env.php排除在版本控制器之外（使用git的话就使用gitignore配置排除），最后在项目的入口文件中引入这个env.php，这样每个环境就可以自行在env.php中配置。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// env.php文件</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'PHP_ENV'</span>) <span class="keyword">or</span> define(<span class="string">'PHP_ENV'</span>, <span class="string">'dev'</span>);</span><br></pre></td></tr></table></figure></p>
<p>这个方案很灵活，但带来的一个问题是要管理的env.php可能会很多，因为一台机器上可能同时部署了好几个项目，每个项目都有一个env.php文件需要维护。</p>
<h4 id="方案二：在web服务器中配置环境变量"><a href="#方案二：在web服务器中配置环境变量" class="headerlink" title="方案二：在web服务器中配置环境变量"></a>方案二：在web服务器中配置环境变量</h4><p>php可以使用getenv()函数拿到环境变量，使用apache或者nginx可以在配置文件中定义这个环境变量，来看一个nginx配置环境变量的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_param  PHP_ENV dev;</span><br></pre></td></tr></table></figure></p>
<p>这个方案不需要在代码中定义环境变量，但还是存在维护多个配置的问题，同时如果是运行控制台的php命令，不通过web服务器，则拿不到对应的环境变量。</p>
<h4 id="方案三：定义linux服务器的环境变量"><a href="#方案三：定义linux服务器的环境变量" class="headerlink" title="方案三：定义linux服务器的环境变量"></a>方案三：定义linux服务器的环境变量</h4><p>getenv()函数可以拿到linux配置的环境变量，通常可以在linux的启动文件/etc/profile中加入如下的命令配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PHP_ENV=&apos;dev&apos;</span><br></pre></td></tr></table></figure></p>
<p>运行web项目，还需要在配置中加入环境变量的读取，这里以nginx+php-fpm为例，需要在php-fpm.conf增加如下的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env[PHP_ENV] = $PHP_ENV //读取linux系统的环境变量</span><br></pre></td></tr></table></figure></p>
<p>最后将. /etc/profile加入到php的启动脚本中去，就大功告成了。<br>这个方案应该是上述方案中可维护性最高的，因为配置的地方最少，但是这个方案也存在一个问题：不够灵活，假如我们的服务器资源吃紧，需要在同一台机器上面既部署开发环境的东西，也部署测试环境的东西，这个方案就不能采用。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>当然，上述三种方案并非是单选题，也可以组合起来用，例如方案二和方案三，当我们在web服务器和linux机器定义了相同的环境变量，则在web项目中会以web服务器的为基准，这样子组合起来使用，将可以应对更多的使用场景。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/18/php7/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/18/php7/" itemprop="url">
                  php7杂谈
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-18T00:00:00+08:00">
                2016-12-18
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>虽然php7在2015年未的时候已经正式发布了，但自己目前所经历过的两家公司都是用着5.x版本，不过，php7注定是未来的主流，最近自己也是开始关注这块，所以写下这篇博客来记录一些自己的理解和思考。</p>
<h3 id="升级到php7"><a href="#升级到php7" class="headerlink" title="升级到php7"></a>升级到php7</h3><p>php7虽然做了大量的改动过，但同时也做了很多向下兼容的工作，所以升级到php7是没有太大问题的，当然其中也包括一些不兼容的点，具体可以参考这篇<a href="http://www.php7.site/book/php7/about-30.html" target="_blank" rel="noopener">文章</a>。我总体看了一遍，有些不兼容的改动基本是很“冷门”的，可能这个关于foreach的修改要特别注意一下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foreach的修改</span></span><br><span class="line">$arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">foreach</span>($arr <span class="keyword">as</span> &amp;$i) &#123;</span><br><span class="line">    var_dump(current($i)); <span class="comment">// php7输出1 1 1 php7之前输出2 3 false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>php7的foreach遍历将不再改变数组的内部指针，所以如果以前的代码有在foreach中使用current得到遍历的下一个元素的，在升级之前需要重构掉代码。</p>
<h3 id="php7新特性"><a href="#php7新特性" class="headerlink" title="php7新特性"></a>php7新特性</h3><p>关于php7新特性的介绍，可以参考官网的<a href="http://php.net/manual/zh/migration70.new-features.php" target="_blank" rel="noopener">说明文档</a>。总体而言，这次php7的升级重点并不是在语言特性上，所以语法糖并不多，相对而言也没有太多亮点的地方。</p>
<h4 id="标量类型声明和返回类型声明"><a href="#标量类型声明和返回类型声明" class="headerlink" title="标量类型声明和返回类型声明"></a>标量类型声明和返回类型声明</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增参数类型支持int、float、string和bool</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(int $i)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回类型支持</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>php是弱类型语言，弱类型语言向来被人诟病的其中一点是缺少“解析前检查”。函数的传参没有类型约束，意味着传入什么东西都可以被接受，直到了运行期问题才会被抛出，这很让人无能为力。<br>php7无疑强化了关于类型的输入和输出，语言也渐渐地严谨化和与强类型挂钩，这样带来的好处就是可以让问题暴露在解析前，让开发者能更早地知道代码的错误之处。我个人认为严谨化和强类型是未来语言发展的重要方向，宽松化和容错性高注定是要立下墓碑，所以php7的这个特性还是很切合时代的发展的。</p>
<h4 id="null合并运算符"><a href="#null合并运算符" class="headerlink" title="null合并运算符"></a>null合并运算符</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// php7之前的写法</span></span><br><span class="line">$a = <span class="keyword">isset</span>($_POST[<span class="string">'a'</span>]) ? $_POST[<span class="string">'a'</span>] : <span class="number">0</span>;</span><br><span class="line"><span class="comment">// php7的写法</span></span><br><span class="line">$a = $_POST[<span class="string">'a'</span>] ?? <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>这个语法糖应该是php7所有新语法中最实用的。之前的代码确实存在太多isset加三目表达式的写法，新语法要节省多少敲击键盘的次数啊，“人生苦短，敲少代码”把。</p>
<h4 id="组合运算符-lt-gt"><a href="#组合运算符-lt-gt" class="headerlink" title="组合运算符&lt;=&gt;"></a>组合运算符&lt;=&gt;</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span> &lt;=&gt; <span class="number">1</span>; <span class="comment">// 0</span></span><br><span class="line"><span class="keyword">echo</span> <span class="number">1</span> &lt;=&gt; <span class="number">2</span>; <span class="comment">// -1</span></span><br><span class="line"><span class="keyword">echo</span> <span class="number">2</span> &lt;=&gt; <span class="number">1</span>; <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>这次推出了新的运算符&lt;=&gt;，现在我能想到的一个应用场景就是在数组排序中使用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// php7之前的写法</span></span><br><span class="line">usort($arr, <span class="function"><span class="keyword">function</span> <span class="params">($x, $y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $x - $y;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// php7的写法</span></span><br><span class="line">usort($arr, <span class="function"><span class="keyword">function</span> <span class="params">($x, $y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $x &lt;=&gt; $y;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>php7之前的写法基本也能满足，新特性并没有带来很好的体验提升，个人认为这个特性或许没有那么“必须”。</p>
<h4 id="匿名类"><a href="#匿名类" class="headerlink" title="匿名类"></a>匿名类</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(string $msg)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $logger;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLogger</span><span class="params">()</span>: <span class="title">Logger</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setLogger</span><span class="params">(Logger $logger)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">$this</span>-&gt;logger = $logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">new</span> Application;</span><br><span class="line">$app-&gt;setLogger(<span class="keyword">new</span> <span class="class"><span class="keyword">class</span> <span class="keyword">implements</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(string $msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>通过new class来实例化一个匿名类，适用于替代一些“用后即焚”的完整类定义。当我看到这个的时候，第一反映是这个特性与单元测试的结合。我们知道单元测试强调快速运行，假如方法中存在调用服务类的地方，需要将服务类接口化并mock一个空实现，传统的实现就要定义一个空实现的类，而有了匿名类，就可以节省这个类，同时还可以支持不同的个性化需求。</p>
<h4 id="通过define定义常量为数组类型"><a href="#通过define定义常量为数组类型" class="headerlink" title="通过define定义常量为数组类型"></a>通过define定义常量为数组类型</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// php7的实现</span></span><br><span class="line">define(<span class="string">'ORDER'</span>, [<span class="string">'unpay'</span> =&gt; <span class="number">1</span>, <span class="string">'pay'</span> =&gt; <span class="number">2</span>]);</span><br><span class="line"><span class="keyword">echo</span> ORDER[<span class="string">'unpay'</span>];</span><br><span class="line"><span class="comment">// php7之前的替代实现</span></span><br><span class="line">define(<span class="string">'ORDER_UNPAY'</span>, <span class="number">1</span>);</span><br><span class="line">define(<span class="string">'ORDER_PAY'</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>php7之前的常量定义只能未int、float、string和bool值，现在就多了一个数组，可以将关联的元素集中化，以前的替代实现就需要数组的每个元素都定义为一个常量，现在就会方便一些。</p>
<h4 id="使用use导入一组类"><a href="#使用use导入一组类" class="headerlink" title="使用use导入一组类"></a>使用use导入一组类</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// php7之前的写法</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">common</span>\<span class="title">helper</span>\<span class="title">A</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">common</span>\<span class="title">helper</span>\<span class="title">B</span> <span class="title">as</span> <span class="title">Be</span>;</span><br><span class="line"><span class="comment">// php7的写法</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">common</span>\<span class="title">helper</span>\&#123;<span class="title">A</span>, <span class="title">B</span> <span class="title">as</span> <span class="title">Be</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>这个语法糖简化了导入同一个命名空间下类的写法，但我认为还是比较麻烦，需要指定具体的类，而不是像java那样直接导入命名空间，在代码中用到的类自动识别到命名空间中，不知未来php是否会往这个方向上靠。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/16/php-error-reporting/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/16/php-error-reporting/" itemprop="url">
                  php关于error_reporting的配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-16T00:00:00+08:00">
                2016-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天将代码上线到测试环境的，突然报错了，但在我本地自测的时候一直是没问题的，真让人感到奇怪，这段出错的代码大概写了如下的逻辑:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">BaseTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在测试环境上调用BaseTest::getName()方法的时候，就会报一个Strict standards的错误。这里应该是自己的一个疏忽，在static方法中是不应该用parent的，但是居然在开发环境不报错！Strict standards应该是指严格标准的错误报告，第一反应就是去看本地php.ini的配置，发现自己本地的php.ini配置的error_reporting是E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT，原来是这里将严格标准的错误报告给过滤了，结果出现了测试环境的错误。在看一下php.ini的描述，里面提到开发环境应该将error_reporting配置为E_ALL级别，而生产环境配置为E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT，自己的开发环境装上php后就默认是去严格标准格式的，这个地方在配置开发环境的时候以后要必须注意了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/25/https-cert/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/25/https-cert/" itemprop="url">
                  浏览器如何验证https证书的可信度
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-25T00:00:00+08:00">
                2016-11-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>部署https站点的时候，服务器通常需要两个东西：https证书和私钥。在浏览器与服务器发起https通讯的时候，服务器会返回部署的https证书给浏览器，那么浏览器是如何确定这个https证书是可以信任的呢？</p>
<h4 id="关于https证书格式"><a href="#关于https证书格式" class="headerlink" title="关于https证书格式"></a>关于https证书格式</h4><p>https证书是带有站点信息的x509证书，在浏览器中可以导出后缀名为crt证书，携带的信息通常有：唯一序列号、证书发行机构、发行机构公钥、有效时间段、证书签名算法、证书签名等。</p>
<h4 id="浏览器的检验过程"><a href="#浏览器的检验过程" class="headerlink" title="浏览器的检验过程"></a>浏览器的检验过程</h4><p>一般情况下，浏览器会内置受信任证书发布结构的公钥，所以就可以用这个公钥来校验证书的可信度。首先来看一张图，看一下https证书生成签名的过程：<br><img src="/2016/11/25/https-cert/1.png" alt=""><br>证书机构拥有自己才知道的私钥，在数字签名函数中加入这个私钥，就生成了这个证书的签名。再来看一张浏览器验证签名过程的图：<br><img src="/2016/11/25/https-cert/2.png" alt=""><br>由于采用了非对称加解密算法，浏览器用公钥对签名进行解密就可以得到摘要，在与证书生成的摘要进行对比，如果一样就表示这个证书是该机构签发的，因为假如证书是伪造的，那么伪造方是肯定不知道正确的私钥，这样用公钥解密出来的摘要肯定与证书生成的摘要不一致。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/queue/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/04/04/queue/" itemprop="url">
                  .NET源码Queue<T>的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-04T00:00:00+08:00">
                2015-04-04
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Queue（队列）是一种先进先出的数据结构，其中最核心的两个方法是Enqueue（入队）和Dequeue（出队）两个操作。Queue<t>的实现与Stack<t>也有相似的地方，例如底层的数据结构同样是靠T[] _array数组对象维系着，也是使用了2倍数组扩容的方式。不过，由于队列具有先进先出的特性，它决定了不能像Stack<t>那样只用一个_size来维系栈尾的下标，队列必须有一个队头_head下标和一个队尾_tail下标来保证先进先出的特性。考虑到队列的存储效率，还必须涉及到循环队列的问题，所以Queue<t>的实现会比Stack<t>更为复杂一些，同样来看一个简化版本的实现：</t></t></t></t></t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line"></span><br><span class="line">namespace OriginalCode</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// 基于.NET源码的简化版实现</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> T[] EMPTY_ARRAY = <span class="keyword">new</span> T[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> _defaultCapacity = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">private</span> T[] _array;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _head; <span class="comment">//头位置</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _tail; <span class="comment">//尾位置</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _size; <span class="comment">//队列元素个数</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            _array = EMPTY_ARRAY;</span><br><span class="line">            _head = <span class="number">0</span>;</span><br><span class="line">            _tail = <span class="number">0</span>;</span><br><span class="line">            _size = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">(<span class="keyword">int</span> capacity)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            _array = <span class="keyword">new</span> T[capacity];</span><br><span class="line">            _head = <span class="number">0</span>;</span><br><span class="line">            _tail = <span class="number">0</span>;</span><br><span class="line">            _size = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment">/// 入队操作</span></span><br><span class="line">        <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="item"&gt;待入队元素&lt;/param&gt;</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span><span class="params">(T item)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_size == _array.Length)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//确定扩充的容量大小</span></span><br><span class="line">                <span class="keyword">int</span> capacity = _array.Length * <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> (capacity &lt; _array.Length + _defaultCapacity)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//.NET源码这样实现的一些基本猜想</span></span><br><span class="line">                    <span class="comment">//由于可以通过调用Queue(int capacity)实例化队列 capacity可以=1 | 2 | 3</span></span><br><span class="line">                    <span class="comment">//这里做与+4做判断 应该是为了提高基本性能 比如当capacity = 1的时候 *2 = 2 这样2很快容易有下一次扩充</span></span><br><span class="line">                    <span class="comment">//不过其实感觉效果并不大 有点设计过度的嫌疑</span></span><br><span class="line">                    capacity = _array.Length + _defaultCapacity;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//实例化一个容量更大的数组</span></span><br><span class="line">                T[] array = <span class="keyword">new</span> T[capacity];</span><br><span class="line">                <span class="keyword">if</span> (_size &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//当需要重新分配数组内存的时候 根据循环队列的特性 这时的_head一定等于_tail</span></span><br><span class="line">                    <span class="comment">//从旧数组_array[_head]到_array[_size-1] 复制到 新数组array[0]...[_size - _head - 1]  </span></span><br><span class="line">                    ArrayCopy(_array, array, <span class="number">0</span>, _head, _size - _head);</span><br><span class="line">                    <span class="comment">//从旧数组_array[0]到_array[_head-1] 复制到 新数组array[_size - _head]...[_size - 1]</span></span><br><span class="line">                    ArrayCopy(_array, array, _size - _head, <span class="number">0</span>, _head);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                _array = array; <span class="comment">//将旧数组指向新数组</span></span><br><span class="line">                _head = <span class="number">0</span>; <span class="comment">//重新将头位置定格为0</span></span><br><span class="line">                _tail = _size; <span class="comment">//重新将尾位置定格为_size</span></span><br><span class="line">            &#125;</span><br><span class="line">            _array[_tail] = item;</span><br><span class="line">            _tail = (_tail + <span class="number">1</span>) % _array.Length;</span><br><span class="line">            _size += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment">/// 出队操作</span></span><br><span class="line">        <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;returns&gt;出队元素&lt;/returns&gt;</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">Dequeue</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_size == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"当前队列为空 不能执行出队操作"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            T result = _array[_head];</span><br><span class="line">            _array[_head] = <span class="keyword">default</span>(T);</span><br><span class="line">            _head = (_head + <span class="number">1</span>) % _array.Length;</span><br><span class="line">            _size -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment">/// 将旧数组的项复制到新数组(这个方法是一个模拟实现，实际情况.NET源码底层用C++实现了更高效的复制)</span></span><br><span class="line">        <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="oldArray"&gt;旧数组&lt;/param&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="newArray"&gt;新数组&lt;/param&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="newArrayBeginIndex"&gt;新数组开始项下标&lt;/param&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="oldArrayBeginIndex"&gt;旧数组开始项下标&lt;/param&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="copyCount"&gt;复制个数&lt;/param&gt;</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ArrayCopy</span><span class="params">(T[] oldArray, T[] newArray, <span class="keyword">int</span> newArrBeginIndex, <span class="keyword">int</span> oldArrBeginIndex, <span class="keyword">int</span> copyCount)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = oldArrBeginIndex, j = newArrBeginIndex; i &lt; oldArrBeginIndex + copyCount; i++,j++)</span><br><span class="line">            &#123;</span><br><span class="line">                newArray[j] = oldArray[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过下面的图来看一下数组容量足够的时候，循环队列的执行过程：</p>
<p><img src="/2015/04/04/queue/1.png" alt=""></p>
<p>基于上面这张图的执行过程，来看一下Dequeue函数的实现。第一步判断的是_size是否为0，是的话就抛出异常。如果当前入队个数大于0，则获取_array[_head]元素作为出队元素，之后就调用default(T)填充_array[_head]的位置。由于是一个循环队列的设计，所以不能简单地将_head+=1，而必须这样_head=(_head+1)%_array.Length，如上图所示，_head有可能指向下标为3的位置，假如这时直接_head += 1变为4的话，就跳出了数组的小标范围，而_head=(_head+1)%_array.Length变为0，则指向了数组最前的位置，实现了循环队列的功能，更好地利用了内存。</p>
<p>接下来看一下Enqueue(T item)函数的实现。承接上图的Queue的状态，假如现在要执行q.Enqueue(“f”)的入队操作，但是很明显数组_array已经满了，那么要怎么办呢？其实原理和Stack的实现类似，也是要通过数组扩容的方式，不过比Stack的数组复制要复杂一些。来继续看图：</p>
<p><img src="/2015/04/04/queue/2.png" alt=""></p>
<p>与Stack<t>一样，影响Queue<t>性能最大因素是数组扩容以及相应的数组复制操作，同样Queue也提供了一个带初始化容量的构造函数Queue(int capacity)，如果我们能估算到队列可能同时存在元素的最大值，就尽量调用这个带capacity的构造函数。</t></t></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/02/stack/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Teroy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Teroy’s Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Teroy’s Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/04/02/stack/" itemprop="url">
                  .NET源码Stack<T>的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-02T00:00:00+08:00">
                2015-04-02
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Stack（栈）是一种后进先出的数据结构，其中最核心的两个方法分别为Push（入栈）和Pop（出栈）两个操作，那么.NET类库是如何实现这种数据结构呢？为了降低学习成本，这里将根据.NET源码的实现，结合其中的核心设计思想，得出一个简化版本的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line"></span><br><span class="line">namespace OriginalCode</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// 基于.NET源码的简化版实现</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stack</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> _defaultCapacity = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">private</span> T[] _array;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _size;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stack</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//默认初始化数组的数量为空</span></span><br><span class="line">            _array = <span class="keyword">new</span> T[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">//初始化数组的数量为0</span></span><br><span class="line">            _size = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment">/// 入栈</span></span><br><span class="line">        <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="item"&gt;入栈的元素&lt;/param&gt;</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Push</span><span class="params">(T item)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_size == _array.Length)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//数组存储已经满了，需重新分配数组大小</span></span><br><span class="line">                <span class="comment">//分配的数组大小为原来的两倍</span></span><br><span class="line">                T[] array = <span class="keyword">new</span> T[_array.Length == <span class="number">0</span> ? _defaultCapacity : <span class="number">2</span> * _array.Length];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将原来的数组Copy到新数组中</span></span><br><span class="line">                Copy(_array, array);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//_array指向新数组</span></span><br><span class="line">                _array = array;</span><br><span class="line">            &#125;</span><br><span class="line">            _array[_size] = item;</span><br><span class="line">            _size += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment">/// 出栈</span></span><br><span class="line">        <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;returns&gt;出栈的元素&lt;/returns&gt;</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">Pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_size == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"栈为空，当前不能执行出栈操作"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _size -= <span class="number">1</span>;</span><br><span class="line">            T result = _array[_size];</span><br><span class="line">            _array[_size] = <span class="keyword">default</span>(T);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">        <span class="comment">/// 将旧数组赋值到新数组(这个方法是一个模拟实现，实际情况.NET源码底层用C++实现了更高效的复制)</span></span><br><span class="line">        <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="oldArray"&gt;旧数组&lt;/param&gt;</span></span><br><span class="line">        <span class="comment">/// &lt;param name="newArray"&gt;新数组&lt;/param&gt;</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Copy</span><span class="params">(T[] oldArray, T[] newArray)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldArray.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                newArray[i] = oldArray[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>必须明确的一点是Stack<t>的底层是靠T[] _array数组对象维系着。首先来看构造函数Stack()，这里做的事情无非就是一些基本的初始化工作，当调用这个无参构造函数的时候，会将_array数组实例化为T[0]，同时将一个_size初始化为0。这个_size主要是用来表示当前栈中存在的元素个数，同时也承担起类似数组下标的作用，标识下一个元素入栈的数组位置。</t></p>
<p>接下来来看一下Push(T item)函数的实现。这里的第一步操作其实就是执行一次判断，判断当前_array数组的元素个数是否已经满了，假如满了的话，就要对数组进行扩充。.NET源码对于数组扩充的设计还是比较巧妙的，当_array为空的时候，默认开始分配的数组个数为4，既new T[4]，假如要插入的是第5个元素的时候，这时数组的个数不足，就声明一个新的T[] array，并将个数扩充为_array个数的2倍，之后再将_array元素一个个复制到新的array中，最后将_array字段指向array，就完成了数组扩充的工作。这一步在前面的代码中的实现应该是很清晰的，不过需要注意的一点是这里的Copy(_array,array)函数是我自己的一个简单的实现，跟.NET源码中的实现是很不一样的，.NET源码是调用一个Array.Copy(this._array, 0, array, 0, this._size)的函数，它的底层应该是用C++实现了数组复制的更好的优化。通过一张图来看一下数组扩容的过程：</p>
<p><img src="/2015/04/02/stack/1.png" alt=""></p>
<p>最后来看一下Pop()函数的实现。首先先判断当前数组的个数是否大于0，小于等于0的话就会抛出异常。之后就将_size-=1，得到要Pop的对象在数组的位置。取出_array[_size]后，就调用default(T)填充_array[_size]的位置，这样做的一个好处是取消对原来的对象的引用，是其能够成为垃圾回收的对象，更好地减少内存的占用。总体而言Pop()实现还是比较简单的。</p>
<p>从前面我们知道，使用Stack<t>数据结构，数组扩容应该是影响性能最大的一个因素。默认情况下，假如要往栈中插入100个对象，意味着数组就要经过4-&gt;8-&gt;16-&gt;32-&gt;64-&gt;128总共5次的数组扩容，那么有没有什么办法可以改善性能呢？答案是有的，.NET源码Stack<t>对象除了提供默认的无参构造函数外，还提供了一个Stack(int capacity)的构造函数，capacity参数其实就是用表示来初始化数组的个数，假如我们能预料到这次插入栈的对象个数的最大值的话（以100为例），就直接这样调用new Stack<t>(100)，这样就能减少不必要的数组扩容，从而提高了Stack的使用性能。</t></t></t></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Teroy" />
          <p class="site-author-name" itemprop="name">Teroy</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/teroy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/teroy" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Douban
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Teroy</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
